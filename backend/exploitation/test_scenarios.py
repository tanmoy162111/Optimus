"""
Exploitation Module Test Scenarios - Phase 4
"""

import sys
import unittest
import logging

logging.basicConfig(level=logging.INFO, format='%(message)s')
logger = logging.getLogger(__name__)


class TestExploitDatabase(unittest.TestCase):
    """Test ExploitDatabase functionality"""
    
    def setUp(self):
        from exploitation.exploit_db import get_exploit_database
        self.db = get_exploit_database()
    
    def test_database_loaded(self):
        """Test that database has templates loaded"""
        self.assertGreater(len(self.db.templates), 20)
        logger.info(f"✓ Database has {len(self.db.templates)} templates")
    
    def test_cve_lookup(self):
        """Test CVE lookup functionality"""
        templates = self.db.get_by_cve("CVE-2021-44228")
        self.assertGreater(len(templates), 0)
        logger.info(f"✓ CVE lookup returned {len(templates)} templates")
    
    def test_service_lookup(self):
        """Test service-based lookup"""
        templates = self.db.get_by_service("mysql")
        self.assertGreater(len(templates), 0)
        logger.info(f"✓ Service lookup returned {len(templates)} templates")


class TestPayloadCrafter(unittest.TestCase):
    """Test PayloadCrafter functionality"""
    
    def setUp(self):
        from exploitation.payload_crafter import get_payload_crafter, ShellType, EncodingType
        self.crafter = get_payload_crafter()
        self.ShellType = ShellType
        self.EncodingType = EncodingType
    
    def test_reverse_shells(self):
        """Test reverse shell generation"""
        shell_types = [
            self.ShellType.BASH,
            self.ShellType.PYTHON,
            self.ShellType.PHP,
            self.ShellType.NC,
        ]
        
        for shell_type in shell_types:
            payload = self.crafter.craft_reverse_shell(
                shell_type=shell_type,
                lhost="10.10.14.1",
                lport=4444
            )
            self.assertIsNotNone(payload.payload)
            self.assertIn("10.10.14.1", payload.payload)
        
        logger.info(f"✓ {len(shell_types)} shell types generated")
    
    def test_sqli_payloads(self):
        """Test SQL injection payloads"""
        injection_types = ["union_basic", "union_string", "blind_sleep", "auth_bypass_or"]
        
        for inj_type in injection_types:
            payload = self.crafter.craft_sqli(injection_type=inj_type)
            self.assertIsNotNone(payload.payload)
        
        logger.info(f"✓ {len(injection_types)} SQLi types generated")
    
    def test_xss_payloads(self):
        """Test XSS payload generation"""
        xss_types = ["basic_script", "basic_img", "basic_svg"]
        
        for xss_type in xss_types:
            payload = self.crafter.craft_xss(xss_type=xss_type)
            self.assertIsNotNone(payload.payload)
        
        logger.info(f"✓ {len(xss_types)} XSS types generated")


class TestMetasploitDatabase(unittest.TestCase):
    """Test Metasploit module database"""
    
    def setUp(self):
        from exploitation.metasploit import get_metasploit_db, PayloadPlatform
        self.db = get_metasploit_db()
        self.PayloadPlatform = PayloadPlatform
    
    def test_database_loaded(self):
        """Test that Metasploit database has modules"""
        stats = self.db.get_stats()
        self.assertGreater(stats["total_modules"], 20)
        logger.info(f"✓ Loaded {stats['total_modules']} Metasploit modules")
    
    def test_cve_lookup(self):
        """Test CVE lookup"""
        modules = self.db.get_by_cve("CVE-2017-0144")
        self.assertGreater(len(modules), 0)
        logger.info(f"✓ EternalBlue found: {modules[0].name}")
    
    def test_service_lookup(self):
        """Test service-based lookup"""
        smb_modules = self.db.get_by_service("smb")
        self.assertGreater(len(smb_modules), 0)
        logger.info(f"✓ SMB modules: {len(smb_modules)}")
    
    def test_payload_selection(self):
        """Test payload selection for targets"""
        payload = self.db.get_payload_for_target(
            platform=self.PayloadPlatform.WINDOWS
        )
        self.assertIn("windows", payload)
        logger.info(f"✓ Windows payload: {payload}")


class TestPromptManager(unittest.TestCase):
    """Test prompt templates"""
    
    def setUp(self):
        from exploitation.prompts import get_prompt_manager, PromptTemplate
        self.manager = get_prompt_manager()
        self.PromptTemplate = PromptTemplate
    
    def test_system_prompts_exist(self):
        """Test that all system prompts are defined"""
        count = 0
        for template in self.PromptTemplate:
            prompt = self.manager.get_system_prompt(template)
            self.assertIsNotNone(prompt)
            self.assertGreater(len(prompt), 50)
            count += 1
        
        logger.info(f"✓ All {count} system prompts defined")
    
    def test_exploit_prompt_building(self):
        """Test exploit generation prompt building"""
        from exploitation.prompts import build_exploit_prompt
        
        prompt = build_exploit_prompt(
            vulnerability={"type": "sql_injection"},
            target={"url": "http://target.com"},
            language="python"
        )
        
        self.assertIn("sql_injection", prompt)
        self.assertIn("target.com", prompt)
        logger.info("✓ Exploit prompt building works")


class TestScenarioSQLi(unittest.TestCase):
    """Scenario: SQL Injection exploitation"""
    
    def test_sqli_scenario(self):
        """Complete SQLi exploitation scenario"""
        logger.info("\n" + "="*50)
        logger.info("SCENARIO: SQL Injection")
        logger.info("="*50)
        
        from exploitation import get_exploit_database, get_payload_crafter
        from exploitation.payload_crafter import ShellType
        
        # Step 1: Get exploit
        db = get_exploit_database()
        finding = {"type": "sql_injection", "url": "http://target/page?id=1"}
        match = db.get_exploit_for_finding(finding, {"target": finding["url"]})
        self.assertIsNotNone(match)
        template, command = match
        logger.info(f"1. Exploit: {template.name}")
        
        # Step 2: Craft payloads
        crafter = get_payload_crafter()
        sqli = crafter.craft_sqli("union_basic", columns=5, waf_bypass=True)
        logger.info(f"2. SQLi payload: {sqli.payload[:40]}...")
        
        # Step 3: Prepare shell
        shell = crafter.craft_reverse_shell(ShellType.BASH, "10.10.14.1", 4444)
        logger.info(f"3. Shell ready: {len(shell.payload)} chars")
        
        logger.info("✓ SQLi scenario complete")


class TestScenarioMetasploit(unittest.TestCase):
    """Scenario: Metasploit exploitation"""
    
    def test_metasploit_scenario(self):
        """Metasploit module selection scenario"""
        logger.info("\n" + "="*50)
        logger.info("SCENARIO: Metasploit")
        logger.info("="*50)
        
        from exploitation.metasploit import get_metasploit_db, PayloadPlatform
        
        # Step 1: Find modules for SMB
        db = get_metasploit_db()
        finding = {"type": "smb", "cve": "CVE-2017-0144", "port": 445}
        modules = db.get_for_finding(finding, target_os="Windows 7")
        self.assertGreater(len(modules), 0)
        logger.info(f"1. Found {len(modules)} modules")
        
        # Step 2: Select best
        best = modules[0]
        logger.info(f"2. Best: {best.name} ({best.reliability})")
        
        # Step 3: Get payload
        payload = db.get_payload_for_target(PayloadPlatform.WINDOWS)
        logger.info(f"3. Payload: {payload}")
        
        logger.info("✓ Metasploit scenario complete")


def run_tests():
    """Run all tests"""
    loader = unittest.TestLoader()
    suite = unittest.TestSuite()
    
    test_classes = [
        TestExploitDatabase,
        TestPayloadCrafter,
        TestMetasploitDatabase,
        TestPromptManager,
        TestScenarioSQLi,
        TestScenarioMetasploit,
    ]
    
    for test_class in test_classes:
        tests = loader.loadTestsFromTestCase(test_class)
        suite.addTests(tests)
    
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)
    
    print("\n" + "="*50)
    print(f"Tests: {result.testsRun} | Failures: {len(result.failures)} | Errors: {len(result.errors)}")
    print("="*50)
    
    return result


if __name__ == "__main__":
    run_tests()
